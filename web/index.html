<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link type="text/css" href="styles.css" rel="stylesheet" />
    <link href="dist/sp-bootstrap.min.css" rel="stylesheet" media="screen">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="shortcut icon" href="images/favicon.png">
    <title>Organize Your Music</title>
    <!-- Custom styles for this template -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
  <body >
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="index.html">
            <span class="navbar-logo">Spotify</span>
            <span class="navbar-title">Organize Your Music</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Main jumbotron for a primary marketing message or call to action -->
      <div id='intro'>
      <div id='main' class="top jumbotron jumbotron-hero container-fluid">
          <div  id="jumbo-dialog">
            <h1 id='ttitle' >Organize Your Music</h1>
            <p id='ttext'>
                Organize your Spotify collection 
                by any of a wide range of musical attributes including
                genre, mood, decade of release and more.
            </p>
            <p>  Login with your Spotify account to get started</p>
            <p><a class="btn btn-primary btn-lg" id='go' role="button">Login with Spotify</a></p>
          </div>
      </div>

        <div class="container ">
          <div class="row features">
             <div class="col-md-offset-2 col-md-8">
                    <h2 class="text-center">Get your music collection in order</h2>
                    <p>
                    With <b> Organize Your Music </b> you can easily order the songs
                    in any of your playlists be a wide range of parameters. Just
                    follow these steps.
                    </p>
                    <ol>
                        <li>  <b> Login </b> with your Spotify
                        credentials. <b> Organize Your Music</b> will place all
                        of your tracks into a number of bins. There are Genre
                        Moods, Decades, and Popularity bins.
                        <li>  <b> Pick </b> pick one of the bins. You can listen
                        to previews of the songs in the bin. If you like it you
                        can ...
                        <li>  <b> Save </b> the bin to Spotify as a playlist 
                    </ol>
              </div> 
          </div>
        </div>
        </div>

  <div class="row ">
  <div id="sidebar" class="sidebar work"> </div>

  <div id="main-wrapper">
      <div class="work" id="main-area">
          <div id='info' class="text-center"></div>
          <div id='tiny-track'> </div>
          <h3 id="playlist-title"> </h3> 
          <div id="playlist-sub-title"> </div>
          <div>
              <button id="save-button" class="btn btn-xs npull-right btn-primary"> 
              Save as playlist </button>
          </div>
          <br>
          <table id="the-track-table" class="table">
            <col width="5%">
            <col width="45%">
            <col width="45%">
            <thead>
                <tr>
                    <th> # </th>
                    <th> title </th>
                    <th> artist </th>
                </tr>
            </thead>
            <tbody id='track-table'> </tbody>
          </table>
      </div>
    </div>

    <div style="clear:both"> </div>
    <div id="footer">
      <div class="container text-center">
            <p class="text-muted">
                Powered by <a href="http://spotify.com">Spotify</a>.
                Created by <a href="http://twitter.com/plamere">@plamere</a>
                at <a href="http://labrosa.ee.columbia.edu/hamr_ismir2016/">The
                Science of Music Hackathon in NYC on Aug 6, 2016</a>.
                Get the <a
                href="https://github.com/plamere/OrganizeYourMusic">source</a>.
            </p>
      </div>
    </div>
    <script src="lib/jquery-1.11.1.min.js"></script>
    <script src="lib/moment.min.js"></script>
    <script src="lib/bootstrap.min.js"></script>
    <script src="lib/underscore-min.js"></script>
    <script type="text/javascript" charset="utf-8"
        src="//cdnjs.cloudflare.com/ajax/libs/q.js/1.4.1/q.min.js"></script>
    <script src="config.js"></script>

<script>
"use strict";
var accessToken = null;
var curUserID = null;
var curTracks = {};
var curArtists = {};
var curAlbums = {};

var skipGenrePhrases = ['christmas'];
var theWorld = null;
var audio = $("<audio>");
var nowPlaying = null;
var curSpool = null;

function refreshTheWorld() {
    var ntracks = Object.keys(curTracks).length;
    var nArtists = numArtists(curTracks);
    info("Found " + ntracks + " tracks  by " + nArtists + " artists in your collection.");

    theWorld = {
        genres:{ },
        moods:{ },
        decades:{ }
    }
    refreshGenres();
    refreshDecades();
    refreshMoods();
    refreshPopularity();

    updateViewOfTheWorld();
}

function showPlaylist(spool) {
    curSpool = spool;
    var nTracks = spool.tracks.length;
    var nArtists = numArtists(spool.tracks);
    $("#playlist-title").text("My " + uname(spool.name) );
    $("#playlist-sub-title").text(nArtists + " artists / " + nTracks + " tracks");

    var tbl = $("#track-table");
    tbl.empty();
    _.each(spool.tracks, function(track, i) {
        var tr = $("<tr>");
        tr.append($("<td>").text(i + 1));
        tr.append($("<td>").text(track.name));
        tr.append($("<td>").text(track.artists[0].name));
        tr.on("click", function() {
            playTrack(track);
        });
        tbl.append(tr);
    });
}

function saveTracksToPlaylist(playlist, tracks) {

    function saveTracks() {
        var uris = [];

        while (tracks.length > 0 && uris.length < 100) {
            var track = tracks.shift();
            uris.push(track.uri);
        }

        var url = "https://api.spotify.com/v1/users/" + curUserID 
            + "/playlists/" + playlist.id + "/tracks";
        var params = {
            uris:uris
        }
        callSpotify("POST", url, params, function(ok, results) {
            if (ok) {
                if (tracks.length > 0) {
                    saveTracks();
                } else {
                    info("playlist saved");
                }
            } else {
                error("Trouble adding tracks to playlist");
            }
        });
    }
    saveTracks();
}

function savePlaylist() {
    if (curSpool != null) {
        info("saving " + uname(curSpool.name));
        var url = "https://api.spotify.com/v1/users/" + curUserID + "/playlists"
        callSpotify("POST", url, {name:"My " + uname(curSpool.name) }, function(ok, results) {
            if (ok) {
                saveTracksToPlaylist(results, curSpool.tracks);
            } else {
                error("Trouble creating playlist");
            }
        })
    }
}

function updateViewOfTheWorld() {
    var minTracksForSection = 5;
    var sidebar = $("#sidebar");
    sidebar.empty();
    var first = true;

    _.each(theWorld, function(pool, name) {
        var spool = sortedPool(pool);
        var head = $("<h4>").text(uname(name));
        head.attr("data-toggle", "collapse");
        head.attr("data-target", "#" + uname(name));
        sidebar.append(head);
        var ul = $("<ul class='playlist-list collapse in'>");
        ul.attr("id", uname(name));
        sidebar.append(ul);
        _.each(spool, function(spoolItem) {
            var tracks = spoolItem.tracks;
            var name = spoolItem.name;
            if (tracks.length >= minTracksForSection) {
                var nArtists = numArtists(spoolItem.tracks);
                var header = $("<li>").text(uname(name));
                var stats = $("<span class='stats'>").text("(" + nArtists + " artists /" 
                    + tracks.length + " tracks)");
                header.append(stats);
                ul.append(header);
                header.on("click", function() {
                    showPlaylist(spoolItem);
                });
                if (first) {
                    first = false;
                    showPlaylist(spoolItem);
                }
            }
        });
    });
}

function numArtists(tracks) {
    var sartists = new Set();

    _.each(tracks, function(track) {
        if (track.artists.length > 0) {
            sartists.add(track.artists[0].id);
        }
    });
    return sartists.size;
}

function nname(s) {
    return s.replace(/ /g, '_');
}

function uname(s) {
    return s.replace(/_/g, ' ');
}

function sortedPool(pool) {
    var out = [];
    _.each(pool, function(tracks, name) {
        out.push( {tracks:tracks, name:name });
    });

    out.sort(function(a,b) {
        if (a.tracks.length > b.tracks.length) {
            return -1;
        } else if (a.tracks.length < b.tracks.length) {
            return 1;
        } else {
            return 0;
        }
    });
    return out;
}

function refreshGenres() {
    theWorld.genres = {};
    _.each(curTracks, function(track) {
        var genres = getGenresForTrack(track);
        _.each(genres, function(genre) {
            if (isGoodGenre(genre)) {
                if (! (genre in theWorld.genres)) {
                    theWorld.genres[genre] = [];
                }
                theWorld.genres[genre].push(track);
            }
        });
    });
}

function refreshMoods() {
    theWorld.moods = {
        chill:[],
        sad:[],
        angry:[],
        happy:[],
        amped:[],
        danceable:[],
    };

    theWorld.styles = {
        acoustic:[],
        instrumental:[],
        live:[],
        spoken_word:[],
        explicit:[],
        clean:[],
        loud:[],
        quiet:[]
    };

    theWorld.added_to_your_collection = {
        today : [],
        this_week : [],
        this_month : [],
        last_month : [],
        in_the_last_six_months : [],
        in_the_last_year : [],
        over_a_year_ago : [],
        over_two_years_ago : [],
        over_five_years_ago : [],
    };
    _.each(curTracks, function(track) {

        if (track.age < 1.5) {
            theWorld.added_to_your_collection.today.push(track);
        }

        if (track.age < 8) {
            theWorld.added_to_your_collection.this_week.push(track);
        }

        if (track.age  < 30) {
            theWorld.added_to_your_collection.this_month.push(track);
        } else if (track.age < 60) {
            theWorld.added_to_your_collection.last_month.push(track);
        }

        if (track.age < 30 * 6) {
            theWorld.added_to_your_collection.in_the_last_six_months.push(track);
        }

        if (track.age < 365) {
            theWorld.added_to_your_collection.in_the_last_year.push(track);
        }

        if (track.age > 365) {
            theWorld.added_to_your_collection.over_a_year_ago.push(track);
        }

        if (track.age > 365 * 2) {
            theWorld.added_to_your_collection.over_two_years_ago.push(track);
        }

        if (track.age > 365 * 5) {
            theWorld.added_to_your_collection.over_five_years_ago.push(track);
        }

        if ('audio_feature' in track) {
            var feats = track.audio_feature;

            // if the track looks like spoken word, then bail after
            // we add it to the speech bucket
            if (feats.speechiness > .8) {
                theWorld.styles.spoken_word.push(track);
                return;
            }

            if (feats.acousticness > .8) {
                theWorld.styles.acoustic.push(track);
            }

            if (feats.energy < .2) {
                theWorld.moods.chill.push(track);
            }

            if (feats.energy > .95) {
                theWorld.moods.amped.push(track);
            }
            
            if (feats.sadness > .8) {
                theWorld.moods.sad.push(track);
            }

            if (feats.happiness > .8) {
                theWorld.moods.happy.push(track);
            }

            if (feats.anger > .8) {
                theWorld.moods.angry.push(track);
            }

            if (feats.danceabilty > .8) {
                theWorld.moods.danceable.push(track);
            }

            if (feats.instrumentalness > .9) {
                console.log('instrumental', track.name);
                theWorld.styles.instrumental.push(track);
            }

            if (feats.liveness > .85) {
                theWorld.styles.live.push(track);
            }

            if (feats.loudness > -5) {
                theWorld.styles.loud.push(track);
            }
            if (feats.loudness < -15) {
                theWorld.styles.quiet.push(track);
            }
        }

        if (track.explicit) {
            theWorld.styles.explicit.push(track);
        } else {
            theWorld.styles.clean.push(track);
        }
    });
}

function refreshDecades() {
    theWorld.decades = {};
    _.each(curTracks, function(track) {
        var decade = getDecadeForTrack(track);
        if (decade != null) {
            if (! (decade in theWorld.decades)) {
                theWorld.decades[decade] = [];
            }
            theWorld.decades[decade].push(track);
        }
    });
    refreshNewMusic();
}

function refreshPopularity() {
    theWorld.popularity = {
        popular:[],
        mainstream:[],
        hipster:[],
        deep_tracks:[]
    };

    _.each(curTracks, function(track) {
        var pop = track.popularity;
        if (pop > 60) {
            theWorld.popularity.popular.push(track);
        } else if (pop > 40) {
            theWorld.popularity.mainstream.push(track);
        } else if (pop > 10) {
            theWorld.popularity.hipster.push(track);
        } else {
            theWorld.popularity.deep_tracks.push(track);
        }
    });
    refreshNewMusic();
}


function refreshNewMusic() {
    var newYear = 2016; // TBD fix  me
    theWorld.decades.now = [];
    _.each(curTracks, function(track) {
        var year = getYearForTrack(track);
        if (year != null) {
            if (year >= newYear) {
                theWorld.decades.now.push(track);
            }
        }
    });
}

function getDecadeForTrack(track) {
    var year = getYearForTrack(track);
    var decade = null;
    if (year != null) {
        decade =  Math.floor(year / 10) * 10
    } 
    return decade;
}

function getYearForTrack(track) {
    var year = null;
    if (track.album.id in curAlbums) {
        var album = curAlbums[track.album.id];
        if ('release_date' in album) {
            var date = album.release_date;
            if (date.length >=4) {
                var syear = date.substring(0,4);
                year = parseInt(syear);
            }
        }
    }
    return year;
}

function getGenresForTrack(track) {
    var genres = [];
    var albumId = track.album.id;
    if (albumId in curAlbums) {
        var album = curAlbums[albumId];
        _.each(album.genres, function(g) {
            genres.push(g);
        });
    }

    _.each(track.artists, function(artist) {
        if (artist.id in curArtists) {
            var detailedArtist = curArtists[artist.id];
            _.each(detailedArtist.genres, function(genre) {
                genres.push(genre);
            });
        }
    });
    return genres;
}

function isGoodGenre(genre) {
    var lgenre = genre.toLowerCase();
    for (var i = 0; i < skipGenrePhrases.length; i++) {
        var phrase = skipGenrePhrases[i];
        if (lgenre.indexOf(phrase) != -1) {
            return false;
        }
    }
    return true;
}

function error(msg) {
    info(msg);
}

function info(msg) {
    $("#info").text(msg);
}

function authorizeUser() {
    var scopes = 'user-library-read playlist-modify-public';
    var url = 'https://accounts.spotify.com/authorize?client_id=' + SPOTIFY_CLIENT_ID +
        '&response_type=token' +
        '&show_dialog=false' +
        '&scope=' + encodeURIComponent(scopes) +
        '&redirect_uri=' + encodeURIComponent(SPOTIFY_REDIRECT_URI);
    document.location = url;
}

function parseArgs() {
    var hash = location.hash.replace(/#/g, '');
    var all = hash.split('&');
    var args = {};
    _.each(all, function(keyvalue) {
        var kv = keyvalue.split('=');
        var key = kv[0];
        var val = kv[1];
        args[key] = val;
    });
    return args;
}

function callSpotify(type, url, json, callback) {
    $.ajax(url, {
        type: type,
        data: JSON.stringify(json),
        dataType: 'json',
        headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json'
        },
        success: function(r) {
            callback(true, r);
        },
        error: function(r) {
            // 2XX status codes are good, but some have no
            // response data which triggers the error handler
            // convert it to goodness.
            if (r.status >= 200 && r.status < 300) {
                callback(true, r);
            } else {
                callback(false, r);
            }
        }
    });
}

function getSpotifyWithRetries(url, data, callback) {
    var curRetry = 0;
    var maxRetries = 10;

    function go() {
        $.ajax(url, {
            dataType: 'json',
            data: data,
            headers: {
                'Authorization': 'Bearer ' + accessToken
            },
            success: function(r) {
                curRetry = 0;
                callback(r);
            },
            error: function(r) {
                // if the status is a 401, we have been
                // logged out, so lets just go back to the start
                // so the user can reauth

                // for larger collections, we will often
                // get 502 errors. Trying again usually
                // works ok

                // if we get a 429, we have hit the rate limit
                // so we need to slow down

                // 2XX status codes are good, but some have no
                // response data which triggers the error handler
                // convert it to goodness.
                if (r.status >= 200 && r.status < 300) {
                    callback(r);
                } else if (r.status == 401) {
                    console.log('going back to the start');
                    window.location = 'index.html';
                } else if (r.status == 502) {
                    if (curRetry++ < maxRetries) {
                        console.log('502 retry', curRetry);
                        setTimeout(go, 500);
                    } else {
                        console.log('502 error', r);
                        callback(null);
                    }
                } else if (r.status == 429) {
                    if (curRetry++ < maxRetries) {
                        console.log('429 retry', curRetry);
                        setTimeout(go, curRetry * 1000);
                    } else {
                        console.log('429 error', r);
                        callback(null);
                    }
                } else {
                    console.log('error', r);
                    callback(null);
                }
            }
        });
    }
    go();
}

function getSpotify(url, data, callback) {
    return getSpotifyWithRetries(url, data, callback);
}


function fetchCurrentUserProfile(callback) {
    var url = 'https://api.spotify.com/v1/me';
    getSpotify(url, null, callback);
}


function playTrack(track) {
    if (track != nowPlaying) {
        audio.attr('src', track.preview_url);
        audio.get(0).play();
        nowPlaying = track;
    } else {
        stopTrack();
    }
}

function stopTrack() {
    audio.get(0).pause();
    nowPlaying = null;
}

function collectAudioAttributes(tracks, isLast) {
    var trackIds = [];
    _.each(tracks, function(track) {
        trackIds.push(track.id);
    });

    getSpotify("https://api.spotify.com/v1/audio-features", 
        { ids: trackIds.join(',')}, function(results) {
        _.each(results.audio_features, function(audio_feature) {
            if (audio_feature) {
                curTracks[audio_feature.id].audio_feature = audio_feature;
                audio_feature.sadness=  (1 - audio_feature.energy) * (1 - audio_feature.valence);
                audio_feature.happiness = audio_feature.energy * audio_feature.valence;
                audio_feature.anger = audio_feature.energy * (1 - audio_feature.valence);
            }
        });
        if (isLast) {
            refreshTheWorld();
        }
    });
}

function collectArtistAttributes(tracks, isLast) {
    function getArtistInfo(aids) {
        getSpotify("https://api.spotify.com/v1/artists", 
            { ids: aids.join(',')}, function(results) {
            _.each(results.artists, function(artist) {
                curArtists[artist.id] = artist;
            });
            refreshTheWorld();
            if (isLast) {
                refreshTheWorld();
            }
        });
    }

    var aids = [];
    var maxArtistsPerCall = 50;
    _.each(tracks, function(track) {
        _.each(track.artists, function(artist) {
            if (! (artist.id in curArtists)) {
                aids.push(artist.id);
                if (aids.length >= maxArtistsPerCall) {
                    getArtistInfo(aids);
                    aids = [];
                }
            }
        });
    });

    if (aids.length > 0) {
        getArtistInfo(aids);
    }
}


function collectAlbumAttributes(tracks, isLast) {
    function getAlbumInfo(aids) {
        getSpotify("https://api.spotify.com/v1/albums", 
            { ids: aids.join(',')}, function(results) {
            _.each(results.albums, function(album) {
                curAlbums[album.id] = album;
            });
            if (isLast)  {
                refreshTheWorld();
            }
        });
    }

    var aids = [];
    var maxAlbumsPerCall = 20;
    _.each(tracks, function(track) {
        if (! (track.album.id in curAlbums)) {
            aids.push(track.album.id);
            if (aids.length >= maxAlbumsPerCall) {
                getAlbumInfo(aids);
                aids = [];
            }
        }
    });

    if (aids.length > 0) {
        getAlbumInfo(aids);
    }
}


var trackTextQueue = [];

function showTracks(tracks) {
    var tt = $("#tiny-track");
    trackTextQueue = tracks.slice();

    function scheduleUpdate() {
        if (trackTextQueue.length > 0) {
            var track = trackTextQueue.shift();
            var text = track.artists[0].name + " - " +  track.name;
            tt.text(text);
            if (trackTextQueue.length > 0) {
                setTimeout(scheduleUpdate, 10);
            }
        } else {
            tt.text("");
        }
    }
    setTimeout(scheduleUpdate, 20);
}

function getSavedTracks(offset) {
    var params = {
        limit:50,
        market:'from_token',
        offset:offset,
    }
    getSpotify("https://api.spotify.com/v1/me/tracks", params, 
        function(results) {
            var now = moment();
            if (results == null) {
                error("Trouble getting your saved tracks");
            } else {
                var tracks = [];
                _.each(results.items, function(item) {
                    if ('id' in item.track) {
                        item.track.added_at = item.added_at;
                        item.track.date_added = moment(item.added_at);
                        item.track.age = moment.duration(now.diff(item.track.date_added)).asDays();
                        tracks.push(item.track);
                    }
                });
                showTracks(tracks);
                _.each(tracks, function(track) {
                    curTracks[track.id] = track;
                });

                var isLast = results.offset + results.items.length >= results.total;

                collectAudioAttributes(tracks, isLast);
                collectArtistAttributes(tracks, isLast);
                collectAlbumAttributes(tracks, isLast);

                if (!isLast) {
                    getSavedTracks(results.offset + results.items.length);
                } else {
                    refreshTheWorld();
                }
            }
        }
    );
}

function isLocalHost() {
    return window.location.host.indexOf('localhost') >= 0;
}

$(document).ready(

    function() {

        if (isLocalHost()) {
            SPOTIFY_REDIRECT_URI = LOCAL_SPOTIFY_REDIRECT_URI;
        } 
        var args = parseArgs();
        window.location.hash = "";
        $(".work").hide();
        if ('error' in args) {
            error("Sorry, I can't read your music collection from Spotify without authorization");
            $("#go").show();
            $("#go").on('click', function() {
                authorizeUser();
            });
        } else if ('access_token' in args) {
            $(".work").show();
            $("#intro").hide();
            accessToken = args['access_token'];
            $("#save-button").on("click", function() {
                savePlaylist();
            });
            fetchCurrentUserProfile(function(user) {
                if (user) {
                    console.log(user);
                    curUserID = user.id;
                    $("#who").text(user.id);
                    getSavedTracks(0);
                    // getSavedAlbums(0);
                } else {
                    error("Trouble getting the user profile");
                }
            });
        } else {
            $("#go").show();
            $("#go").on('click', function() {
                authorizeUser();
            });
        }
    }
);

</script>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3675615-27']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type =
'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>
